<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Install MongoDB Cluster | Tutorial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="How to Install a MongoDB Sharded Cluster on CentOS 7Sharding is a MongoDB process to store data-set across different machines. It allows you to do a horizontal scale of data, partition data across ind">
<meta property="og:type" content="article">
<meta property="og:title" content="Install MongoDB Cluster">
<meta property="og:url" content="http://tutorial.getmedik.co.id/2019/12/24/mongodb/index.html">
<meta property="og:site_name" content="Tutorial">
<meta property="og:description" content="How to Install a MongoDB Sharded Cluster on CentOS 7Sharding is a MongoDB process to store data-set across different machines. It allows you to do a horizontal scale of data, partition data across ind">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-12-24T05:35:54.669Z">
<meta property="article:modified_time" content="2019-12-24T07:22:58.276Z">
<meta property="article:author" content="Harry">
<meta property="article:tag" content="MongoDB">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Tutorial" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tutorial</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tutorial.getmedik.co.id"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="[layout]-mongodb" class="article article-type-[layout]" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/24/mongodb/" class="article-date">
  <time datetime="2019-12-24T05:35:54.669Z" itemprop="datePublished">2019-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Install MongoDB Cluster
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="How-to-Install-a-MongoDB-Sharded-Cluster-on-CentOS-7"><a href="#How-to-Install-a-MongoDB-Sharded-Cluster-on-CentOS-7" class="headerlink" title="How to Install a MongoDB Sharded Cluster on CentOS 7"></a><strong>How to Install a MongoDB Sharded Cluster on CentOS 7</strong></h1><p><strong>Sharding</strong> is a MongoDB process to store data-set across different machines. It allows you to do a horizontal scale of data, partition data across independent instances, and it can be ‘Replica Sets’. Data-set partitioning on ‘Sharding’ uses shard key. Sharding allows you to add more machines based on data growth on your stack.</p>
<hr>
<a id="more"></a>
<h3 id="Sharding-and-Replication"><a href="#Sharding-and-Replication" class="headerlink" title="Sharding and Replication"></a><strong>Sharding and Replication</strong></h3><p>Let’s make it simple. When you have collections of music, ‘Sharding’ will save and keep your music collections into a different folder. ‘Replication,’ on the other hand, is just syncing your music collections to other instances.</p>
<hr>
<h3 id="Three-Sharding-Components"><a href="#Three-Sharding-Components" class="headerlink" title="Three Sharding Components"></a><strong>Three Sharding Components</strong></h3><p><strong>Shard</strong> - Used to store all data, and in a production environment, each shard is replica sets. Provides high-availability and data consistency.</p>
<hr>
<p><strong>Config Server</strong> - Used to store cluster metadata, contains a mapping of cluster data set and shards. This data is used by mongos/query server to deliver operations. It’s recommended to use more than 3 instances in production.</p>
<hr>
<p><strong>Mongos/Query Router</strong> - This is just mongo instances running as application interfaces. The application will make requests to mongos instances, and then mongos will deliver the requests using shard key to the shards replica sets.</p>
<hr>
<p><strong><center>Prerequisites</center></strong></p>
<ul>
<li>2 centOS 7 server as Config Replica Sets</li>
<li>10.0.15.31      configsvr1</li>
<li>10.0.15.32      configsvr2</li>
<li>4 CentOS 7 server as Shard Replica Sets</li>
<li>10.0.15.21      shardsvr1</li>
<li>10.0.15.22      shardsvr2</li>
<li>10.0.15.23      shardsvr3</li>
<li>10.0.15.24      shardsvr4</li>
<li>1 CentOS 7 server as mongos/Query Router</li>
<li>10.0.15.11       mongos</li>
<li>Root privileges</li>
<li>Each server connected to another server<h4 id="Step-1-Disable-SELinux-and-Configure-Hosts"><a href="#Step-1-Disable-SELinux-and-Configure-Hosts" class="headerlink" title="Step 1 - Disable SELinux and Configure Hosts"></a><strong>Step 1 - Disable SELinux and Configure Hosts</strong></h4>For this tutorial, we will disable SELinux. Change SELinux configuration from ‘enforcing’ to ‘disabled’.</li>
</ul>
<p>Connect to all nodes through OpenSSH.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@SERVERIP</span><br></pre></td></tr></table></figure>

<p>Disable SELinux by editing the configuration file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysconfig&#x2F;selinux</span><br></pre></td></tr></table></figure>

<p>Change SELinux value to ‘disabled’.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELINUX&#x3D;disabled</span><br></pre></td></tr></table></figure>
<p>Save and exit.</p>
<p>Next, edit the hosts file on each server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;hosts</span><br></pre></td></tr></table></figure>
<p>Paste the following hosts configuration:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">10.0.15.31      configsvr1</span><br><span class="line">10.0.15.32      configsvr2</span><br><span class="line">10.0.15.11      mongos</span><br><span class="line">10.0.15.21      shardsvr1</span><br><span class="line">10.0.15.22      shardsvr2</span><br><span class="line">10.0.15.23      shardsvr3</span><br><span class="line">10.0.15.24      shardsvr4</span><br></pre></td></tr></table></figure>
<p>Save and exit.</p>
<p>Now restart all servers:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Install-MongoDB-on-All-Instances"><a href="#Step-2-Install-MongoDB-on-All-Instances" class="headerlink" title="Step 2 - Install MongoDB on All Instances"></a><strong>Step 2 - Install MongoDB on All Instances</strong></h3><p>We will use latest MongoDB (MongoDB 3.4) for all instances. Add new MongoDB repository by executing the following commands:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;&#39;EOF&#39; &gt;&gt; &#x2F;etc&#x2F;yum.repos.d&#x2F;mongodb.repo</span><br><span class="line">[mongodb-org-3.4]</span><br><span class="line">name&#x3D;MongoDB Repository</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;repo.mongodb.org&#x2F;yum&#x2F;redhat&#x2F;$releasever&#x2F;mongodb-org&#x2F;3.4&#x2F;x86_64&#x2F;</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;www.mongodb.org&#x2F;static&#x2F;pgp&#x2F;server-3.4.asc</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>Now install mongodb 3.4 from mongodb repository using the yum command below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install mongodb-org</span><br></pre></td></tr></table></figure>
<p>After mongodb is installed, use ‘mongo’ or ‘mongod’ command in the following way to check version details.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --version</span><br></pre></td></tr></table></figure>
<p>Install MongoDB on All Instances</p>
<h3 id="Step-3-Create-Config-Server-Replica-Set"><a href="#Step-3-Create-Config-Server-Replica-Set" class="headerlink" title="Step 3 - Create Config Server Replica Set"></a><strong>Step 3 - Create Config Server Replica Set</strong></h3><p>In the prerequisites section, we’ve already defined config server with 2 machines ‘configsvr1’ and ‘configsvr2’. And in this step, we will configure it to be a replica set.</p>
<p>If there is mongod service running on the server, stop it with the following systemctl command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mongod</span><br></pre></td></tr></table></figure>
<p>Edit the default mongodb configuration ‘mongod.conf’.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;mongod.conf</span><br></pre></td></tr></table></figure>
<p>Change DB storage path to your own directory. We will use ‘/data/db1’ for the first server, and ‘/data/db2’ directory for second config server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">   dbPath: &#x2F;data&#x2F;db1</span><br></pre></td></tr></table></figure>
<p>Change the value of the line ‘bindIP’ to your internal network address. ‘configsvr1’ with IP address 10.0.15.31, and the second server with 10.0.15.32.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bindIP: 10.0.15.31</span><br></pre></td></tr></table></figure>
<p>In the replication section, set a replication name.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replication:</span><br><span class="line">   replSetName: &quot;replconfig01&quot;</span><br></pre></td></tr></table></figure>
<p>And under sharding section, define a role of the instances. We will use these two instances as ‘configsvr’.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sharding:</span><br><span class="line">   clusterRole: configsvr</span><br></pre></td></tr></table></figure>
<p>Save and exit.</p>
<p>Next, we must create a new directory for MongoDB data, and then change the ownership permissions of that directory to the ‘mongod’ user.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;db1</span><br><span class="line">chown -R mongod:mongod &#x2F;data&#x2F;db1</span><br></pre></td></tr></table></figure>
<p>Next, start the mongod service with the following command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --config &#x2F;etc&#x2F;mongod.conf</span><br></pre></td></tr></table></figure>
<p>You can check mongod service is running on port 27017 with the netstat command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -plntu</span><br></pre></td></tr></table></figure>
<p>Create Config Server Replica Set</p>
<p>Configsvr1 and Configsvr2 are ready for the replica set. Connect to the ‘configsvr1’ server and access the mongo shell.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@configsvr1</span><br><span class="line">mongo --host configsvr1 --port 27017</span><br></pre></td></tr></table></figure>
<p>Initiate the replica set name with all configsvr members using the query below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate(</span><br><span class="line">  &#123;</span><br><span class="line">    _id: &quot;replconfig01&quot;,</span><br><span class="line">    configsvr: true,</span><br><span class="line">    members: [</span><br><span class="line">      &#123; _id : 0, host : &quot;configsvr1:27017&quot; &#125;,</span><br><span class="line">      &#123; _id : 1, host : &quot;configsvr2:27017&quot; &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>If you get a results ‘{ “ok” : 1 }’, it means the configsvr is already configured with the replica set.</p>
<p>Initiate the replica set name with all configsvr members</p>
<p>and you will be able to see which node is master and which node is secondary.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rs.isMaster()</span><br><span class="line">rs.status()</span><br></pre></td></tr></table></figure>
<p>The configuration of Config Server Replica Set is done.</p>
<p>configuration of Config Server Replica Set</p>
<h3 id="Step-4-Create-Shard-Replica-Sets"><a href="#Step-4-Create-Shard-Replica-Sets" class="headerlink" title="Step 4 - Create Shard Replica Sets"></a><strong>Step 4 - Create Shard Replica Sets</strong></h3><p>In this step, we will configure 4 centos 7 servers as ‘Shard’ server with 2 ‘Replica Set’.</p>
<p>2 server - ‘shardsvr1’ and ‘shardsvr2’ with replica set name: ‘shardreplica01’<br>2 server - ‘shardsvr3’ and ‘shardsvr4’ with replica set name: ‘shardreplica02’<br>Connect to each server and stop the mongod service (If the service is running), and edit the MongoDB configuration file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mongod</span><br><span class="line">vim &#x2F;etc&#x2F;mongod.conf</span><br></pre></td></tr></table></figure>
<p>Change default storage to your specific directory.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">   dbPath: &#x2F;data&#x2F;db1</span><br></pre></td></tr></table></figure>
<p>In the ‘bindIP’ line, change the value to your internal network address.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bindIP: 10.0.15.21</span><br></pre></td></tr></table></figure>
<p>In the replication section, you can use ‘shardreplica01’ for the first and second instances. And use ‘shardreplica02’ for third and fourth shard server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replication:</span><br><span class="line">   replSetName: &quot;shardreplica01&quot;</span><br></pre></td></tr></table></figure>
<p>Next, define the role of the server. We will use all this as shardsvr instances.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sharding:</span><br><span class="line">   clusterRole: shardsvr</span><br></pre></td></tr></table></figure>
<p>Save and exit.</p>
<p>Now create a new directory for MongoDB data.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;db1</span><br><span class="line">chown -R mongod:mongod &#x2F;data&#x2F;db1</span><br></pre></td></tr></table></figure>
<p>Start the mongod service.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --config &#x2F;etc&#x2F;mongod.conf</span><br></pre></td></tr></table></figure>
<p>Check whether MongoDB is running with the command below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -plntu</span><br></pre></td></tr></table></figure>
<p>You will see MongoDB is running on the local network address.</p>
<p>Create Shard Replica Sets</p>
<p>Next, create a new replica set for these 2 shard instances. Connect to ‘shardsvr1’ and access the mongo shell.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@shardsvr1</span><br><span class="line">mongo --host shardsvr1 --port 27017</span><br></pre></td></tr></table></figure>
<p>Initiate the replica set with the name ‘shardreplica01’, and the members are ‘shardsvr1’ and ‘shardsvr2’.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate(</span><br><span class="line">   &#123;</span><br><span class="line">     _id : &quot;shardreplica01&quot;,</span><br><span class="line">     members: [</span><br><span class="line">       &#123; _id : 0, host : &quot;shardsvr1:27017&quot; &#125;,</span><br><span class="line">       &#123; _id : 1, host : &quot;shardsvr2:27017&quot; &#125;</span><br><span class="line">     ]</span><br><span class="line">   &#125;</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>
<p>If there is no error, you will see results as shown below.</p>
<p>Results from shardsvr3 and shardsvr4 with replica set name ‘shardreplica02’.</p>
<p>Initiate the replica set</p>
<p>Redo this step on shardsvr3 and shardsvr4 servers with different replica set name ‘shardreplica02’.</p>
<p>Now we’ve created 2 replica sets as the shard - ‘shardreplica01’ and ‘shardreplica02’.</p>
<h3 id="Step-5-Configure-mongos-Query-Router"><a href="#Step-5-Configure-mongos-Query-Router" class="headerlink" title="Step 5 - Configure mongos/Query Router"></a><strong>Step 5 - Configure mongos/Query Router</strong></h3><p>The ‘Query Router’ or mongos is just instances that are running ‘mongos’. You can run mongos with the configuration file, or run it with just a command line.</p>
<p>Login to the mongos server and stop the MongoDB service.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@mongos  </span><br><span class="line">systemctl stop mongod</span><br></pre></td></tr></table></figure>
<p>Run mongos with the command below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos --configdb &quot;replconfig01&#x2F;configsvr1:27017,configsvr2:27017&quot;</span><br></pre></td></tr></table></figure>
<p>use the ‘–configdb’ option to define the config server. If you are on production, use at least 3 config servers.</p>
<p>You will see results below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Successfully connected to configsvr1:27017</span><br><span class="line"> Successfully connected to configsvr2:27017</span><br><span class="line">mongos instances are running.</span><br><span class="line">Configure mongos&#x2F;Query Router</span><br></pre></td></tr></table></figure>
<h3 id="Step-6-Add-shards-to-mongos-Query-Router"><a href="#Step-6-Add-shards-to-mongos-Query-Router" class="headerlink" title="Step 6 - Add shards to mongos/Query Router"></a><strong>Step 6 - Add shards to mongos/Query Router</strong></h3><p>Open another shell from step 5, connect to the mongos server again and access the mongo shell.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@mongos</span><br><span class="line">mongo --host mongos --port 27017</span><br></pre></td></tr></table></figure>
<p>Add shard server with sh mongodb query.</p>
<p>For ‘shardreplica01’ instances.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard( &quot;shardreplica01&#x2F;shardsvr1:27017&quot;)</span><br><span class="line">sh.addShard( &quot;shardreplica01&#x2F;shardsvr2:27017&quot;)</span><br></pre></td></tr></table></figure>
<p>For ‘shardreplica02’ instances.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard( &quot;shardreplica02&#x2F;shardsvr3:27017&quot;)</span><br><span class="line">sh.addShard( &quot;shardreplica02&#x2F;shardsvr4:27017&quot;)</span><br></pre></td></tr></table></figure>
<p>Make sure there is no error and check the shard status.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.status()</span><br></pre></td></tr></table></figure>
<p>You will sharding status as shown in the screenshot below.</p>
<p>Add shards to mongos/Query Router</p>
<p>We have 2 shard replica set and 1 mongos instance running on our stack.</p>
<h3 id="Step-7-Testing"><a href="#Step-7-Testing" class="headerlink" title="Step 7 - Testing"></a><strong>Step 7 - Testing</strong></h3><p>Now we’ll test the MongoDB server by enabling sharding and then add documents.</p>
<p>Access the mongos server mongo shell.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@mongos</span><br><span class="line">mongo --host mongos --port 27017</span><br></pre></td></tr></table></figure>
<p>Enable Sharding for a Database</p>
<p>Create a new database and enable sharding for the new database.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use lemp</span><br><span class="line">sh.enableSharding(&quot;lemp&quot;)</span><br><span class="line">sh.status()</span><br></pre></td></tr></table></figure>
<p>Now see the status of the database - it has been partitioned to the replica set ‘shardreplica01’.</p>
<p>Next, add new collections to the database with sharding support. We will add new collection named ‘stack’ with shard collection ‘name’, and then see database and collections status.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh.shardCollection(&quot;lemp.stack&quot;, &#123;&quot;name&quot;:1&#125;)</span><br><span class="line">sh.status()</span><br></pre></td></tr></table></figure>
<p>New collections ‘stack’ with shard collection ‘name’ has been added.</p>
<p>Add documents to collections ‘stack’.</p>
<p>Now insert the documents to the collections. When we add documents to the collection on sharded cluster, we must include the ‘shard key’.</p>
<p>You can use an example below. We are using shard key ‘name’, as we added when enabling sharding for collections.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.stack.save(&#123;</span><br><span class="line">    &quot;name&quot;: &quot;LEMP Stack&quot;,</span><br><span class="line">    &quot;apps&quot;: [&quot;Linux&quot;, &quot;Nginx&quot;, &quot;MySQL&quot;, &quot;PHP&quot;],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Documents in successfully added to the collection, as shown in the following screenshot.</p>
<p>Add documents to collections ‘stack’.</p>
<p>If you want to test the database, you can connect to the replica set ‘shardreplica01’ PRIMARY server and open the mongo shell. I am logging in to the ‘shardsvr2’ PRIMARY server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@shardsvr2</span><br><span class="line">mongo --host shardsvr2 --port 27017</span><br></pre></td></tr></table></figure>
<p>Check database available on the replica set.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show dbs</span><br><span class="line">use lemp</span><br><span class="line">db.stack.find()</span><br></pre></td></tr></table></figure>
<p>MongoDB sharded cluster on CentOS 7 successfully installed and deployed.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tutorial.getmedik.co.id/2019/12/24/mongodb/" data-id="ck4jjmhxz0001n8jwftnm78xk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/12/24/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/24/mongodb/">Install MongoDB Cluster</a>
          </li>
        
          <li>
            <a href="/2019/12/24/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Harry<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>